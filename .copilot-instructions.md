git clone <repository-url>
# Copilot Instructions for Innovative Ideas Management System

## Project Overview
Enterprise-grade React + TypeScript application for idea submission, approval workflow, and task tracking. Hosted on SharePoint 2016 at `http://hospp16srv:36156/innovativeIdeas/dist/` using hash-based routing for compatibility.

**Core Purpose**: Enable employees to submit innovative ideas, track them through approval workflows, convert approved ideas into actionable tasks, and maintain full audit trails.

## Technical Architecture

### Stack & Dependencies
- **Frontend**: React 19.2.0 + TypeScript 5.9.3 + Vite 7.1.12
- **Routing**: React Router v7 with HashRouter (SharePoint compatibility)
- **UI Libraries**: Bootstrap 5.3.8, Lucide React icons, Chart.js, React Flow (@xyflow/react)
- **Build**: Vite with custom base path `/innovativeIdeas/dist/` for production
- **Testing**: Jest 30.2.0 + React Testing Library
- **State**: React Context API (no Redux/Zustand)

### SharePoint Integration
**Base URL**: `http://hospp16srv:36156`
**Lists**:
1. `innovative_ideas` - Main ideas with Title, Description, Status, Category, Priority, Attachments
2. `innovative_idea_trail` - Audit trail events (submitted, approved, implementation_started, implementation_completed, etc.)
3. `ino_ideas_tasks` - Tasks linked to ideas via IdeaId lookup field with AssignedTo (Person/Group)

**Authentication**: Windows Authentication with CSRF protection via SharePoint form digest
**API**: SharePoint 2016 REST API (`/_api/web/lists/getbytitle(...)`) with OData queries

### Project Structure
```
src/
â”œâ”€â”€ contexts/
â”‚   â”œâ”€â”€ AppProviders.tsx          # Root provider composition
â”‚   â”œâ”€â”€ DataContext.tsx           # â­ Core data state, status updates, trail events
â”‚   â”œâ”€â”€ UserContext.tsx           # User authentication, permissions, roles
â”‚   â”œâ”€â”€ ThemeContext.tsx          # Dark/light mode
â”‚   â”œâ”€â”€ NotificationContext.tsx   # Toast notifications
â”‚   â””â”€â”€ UIContext.tsx             # UI state management
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ ideaApi.ts               # â­ SharePoint REST API calls (ideas, tasks, trail)
â”‚   â””â”€â”€ userApi.ts               # â­ User/group API, permission checks
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ secureApi.ts             # â­ API client with CSRF, retry logic, rate limiting
â”‚   â”œâ”€â”€ sharePointInit.ts        # SharePoint context initialization
â”‚   â”œâ”€â”€ logger.ts                # Centralized logging (logInfo, logError)
â”‚   â”œâ”€â”€ security.ts              # Security utilities
â”‚   â””â”€â”€ performance.ts           # Performance monitoring
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ MainDashboard.tsx        # â­ KPIs, idea lists, status breakdown
â”‚   â”œâ”€â”€ IdeaFormPage.tsx         # â­ New idea submission form
â”‚   â”œâ”€â”€ IdeaDetailPage.tsx       # â­ View/edit idea, status changes
â”‚   â”œâ”€â”€ IdeaTrailModal.tsx       # â­ React Flow timeline visualization
â”‚   â”œâ”€â”€ ApproverDashboard.tsx    # Approver-specific view
â”‚   â”œâ”€â”€ ApprovedIdeasPage.tsx    # Admin view of approved ideas with inline tasks
â”‚   â”œâ”€â”€ IdeaTaskFormPage.tsx     # Create tasks for ideas
â”‚   â”œâ”€â”€ TaskDiscussionPage.tsx   # Task details and discussions
â”‚   â”œâ”€â”€ MyIdeas.tsx              # User's submitted ideas
â”‚   â””â”€â”€ MyTasks.tsx              # User's assigned tasks
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ common/                  # Reusable UI components
â”‚   â”‚   â”œâ”€â”€ ErrorBoundary.tsx
â”‚   â”‚   â”œâ”€â”€ LoadingSpinner.tsx
â”‚   â”‚   â”œâ”€â”€ StatusBar.tsx
â”‚   â”‚   â”œâ”€â”€ Toast.tsx
â”‚   â”‚   â”œâ”€â”€ TopUtilityBar.tsx
â”‚   â”‚   â””â”€â”€ UserProfile.tsx
â”‚   â””â”€â”€ control/
â”‚       â””â”€â”€ TopControlPanel.tsx  # Main navigation/control panel
â”œâ”€â”€ styles/
â”‚   â””â”€â”€ index.css               # Global styles
â”œâ”€â”€ types/
â”‚   â””â”€â”€ index.ts                # Shared TypeScript interfaces
â”œâ”€â”€ App.tsx                     # â­ Router setup, lazy loading, role-based routing
â””â”€â”€ main.tsx                    # Entry point, SharePoint init

deploy.bat                      # Batch script: npm run build:sharepoint + deploy.ps1
deploy.ps1                      # PowerShell: uploads files to SharePoint via REST API
vite.config.js                  # â­ Base path, chunking strategy, SharePoint asset exclusion
```

## Key Files Deep Dive

### 1. `src/contexts/DataContext.tsx` (737 lines)
**Purpose**: Central data management for ideas, tasks, discussions, trail events

**Key Interfaces**:
- `Idea`: id, title, description, status, createdBy, category, priority
- `Task`: id, ideaId, title, status, assignedTo[], progress, dueDate
- `IdeaTrailEvent`: eventType (submitted|approved|implementation_started|implementation_completed|...), actor, timestamp, metadata

**Critical Functions**:
- `loadIdeas()`: Fetches all ideas, converts ProcessedIdea â†’ Idea format
- `loadTasks()`: Loads tasks for all ideas with retry logic
- `loadIdeaTrailEvents()`: Fetches audit trail from `innovative_idea_trail`
- `updateIdeaStatus(ideaId, newStatus)`: **â­ Core status transition logic**
  - Approved â†’ In Progress: creates `implementation_started` event
  - In Progress â†’ Completed: creates `implementation_completed` event
  - Updates idea via REST API, creates trail events automatically
- `createInitialTrailEvents()`: Backfills trail events for existing ideas

**Status Flow**:
```
Pending â†’ Approved â†’ In Progress â†’ Completed
                  â†˜ Rejected
```

### 2. `src/services/ideaApi.ts` (861 lines)
**Purpose**: SharePoint REST API wrapper with data transformation

**Key Methods**:
- `getIdeas(filter?)`: GET with $select, $expand, $orderby
- `createIdea(data, attachments?)`: POST with file uploads
- `updateIdea(id, data)`: PATCH with X-HTTP-Method override
- `getTasksForIdea(ideaId)`: Filter tasks by IdeaId lookup
- `createTask(data)`: POST to ino_ideas_tasks
- `createIdeaTrailEvent(data)`: POST audit events
- `uploadAttachments()`: Multi-file upload via AttachmentFiles endpoint

**Field Mappings**:
```typescript
IDEA_SELECT = "ID,Title,Description,Status,Category,Priority,Created,Modified,Author/Id,Author/Title,ApprovedBy/Id,ApprovedBy/Title,Attachments,AttachmentFiles"
TASK_SELECT = "ID,Title,Body,Status,Priority,PercentComplete,DueDate,StartDate,AssignedTo/Id,AssignedTo/Title,AssignedTo/EMail,IdeaId/Id,IdeaId/Title"
IDEA_TRAIL_SELECT = "ID,Idea/Id,Idea/Title,Task/Id,Task/Title,EventType,Title,Description,Actor/Id,Actor/Title,PreviousStatus,NewStatus,Comments,Metadata,Created"
```

### 3. `src/services/userApi.ts` (250 lines)
**Purpose**: User authentication, permissions, role detection

**Key Logic**:
- `getCurrentUserInfo()`: Fetches user + groups + permissions
- **â­ Role Assignment**:
  - `isAdmin`: In "Innovative Ideas - Administrators" group OR IsSiteAdmin OR hasFullControl
  - `isApprover`: In "Innovative Ideas - Approvers" group OR isAdmin
  - `isContributor`: **Always `true`** for all authenticated users (no group check)
- `getUserGroups()`: Multi-method approach (standard API + fallback sitegroups check)
- `getUserPermissions()`: Parses SharePoint permission masks (High/Low bits)

**Permission Model**: All authenticated users can submit ideas; only specific groups can approve/admin.

### 4. `src/utils/secureApi.ts` (272 lines)
**Purpose**: Secure HTTP client with CSRF protection, retry logic, rate limiting

**Features**:
- `getFormDigest()`: Fetches SharePoint form digest for POST/PATCH/DELETE
- Automatic retry with exponential backoff (3 attempts)
- Request deduplication via Map-based queue
- Rate limiting (100ms delay between requests)
- Comprehensive error logging via `logger.ts`
- Credentials: 'include' for Windows Authentication

**Configuration**:
```typescript
DEFAULT_CONFIG = {
  baseUrl: 'http://hospp16srv:36156',
  lists: { ideas, tasks, discussions, ideaTrail }
}
```

### 5. `src/pages/MainDashboard.tsx` (599 lines)
**Purpose**: Main landing page with KPIs, status breakdown, recent ideas

**Key Metrics**:
- Total ideas, Pending, Approved, In Progress, Rejected, Completed
- Approval rate: `(Approved + In Progress + Completed) / Total * 100`
- Ideas in implementation: `Completed + In Progress`

**UI Components**:
- KPI cards with icons and trend indicators
- Status grid: Pending | Approved | In Progress (3 columns)
- Recent ideas list with click-to-detail navigation
- Quick actions: Submit Idea, View My Ideas, My Tasks

### 6. `src/pages/IdeaTrailModal.tsx` (React Flow)
**Purpose**: Visual timeline of idea lifecycle using React Flow

**Data Processing**:
- Converts `IdeaTrailEvent[]` â†’ React Flow nodes/edges
- Node types: submitted, approved, implementation_started, implementation_completed
- Edge connections based on event sequence (timestamp ordering)
- Custom node styling per event type with emojis (ğŸ¯ ğŸš€ ğŸ‰)

**Critical**: Must populate edges array; empty edges = no connections visible

### 7. `src/App.tsx` (149 lines)
**Purpose**: Root component with lazy loading and role-based routing

**Routes**:
- `/` - MainDashboard (all users)
- `/approver` - ApproverDashboard (approver+ only)
- `/approved-ideas` - ApprovedIdeasPage (admin+ only)
- `/idea/new` - IdeaFormPage (all users)
- `/idea/:id` - IdeaDetailPage (all users)
- `/idea/:id/task/new` - IdeaTaskFormPage (admin+ only)
- `/task/:id` - TaskDiscussionPage (all users)
- `/my-ideas` - MyIdeas (all users)
- `/my-tasks` - MyTasks (all users)

**Lazy Loading**: All pages via `React.lazy()` with Suspense fallback

## Workflow & Business Rules

### Idea Status Transitions
1. **Pending** (initial): Newly submitted ideas awaiting review
2. **Approved**: Approver/admin accepted the idea
3. **In Progress**: Implementation started (creates `implementation_started` trail event)
4. **Completed**: Implementation finished (creates `implementation_completed` trail event)
5. **Rejected**: Idea declined by approver/admin

**Automatic Trail Events**:
- Status change Approved â†’ In Progress: `implementation_started` event
- Status change In Progress â†’ Completed: `implementation_completed` event
- All status changes: `status_changed` event with previousStatus/newStatus

### Task Management
- Tasks created via `/idea/:id/task/new` (admin/approver only)
- Linked to ideas via `IdeaId` lookup field
- Supports multi-user assignment (AssignedTo person/group field)
- Task statuses: Not Started | In Progress | Completed | On Hold
- Progress tracking via `PercentComplete` (0-100)

### User Permissions
- **Contributor (all authenticated)**: Submit ideas, view all ideas, comment, view own tasks
- **Approver**: + Approve/reject ideas, change status, create tasks
- **Administrator**: + All permissions, manage users, view analytics

## Coding Standards

### TypeScript Guidelines
- Explicit return types on all functions (avoid inference ambiguity)
- Optional chaining for API data: `idea?.approvedBy?.name`
- Null guards before rendering: `if (!idea) return <LoadingSpinner />`
- Interface over type alias for data structures
- Strict null checks enabled

### React Patterns
- Functional components only (no class components)
- Custom hooks in `src/hooks/` directory
- Context for cross-component state (no prop drilling)
- `useMemo` for expensive computations (filtering, sorting)
- `useCallback` for event handlers to prevent re-renders
- Error boundaries around lazy-loaded components

### API Integration
- Always use `sharePointApi` from `utils/secureApi.ts`
- Include `$select` to minimize payload (list only needed fields)
- Use `$expand` for lookup fields (Author, ApprovedBy, AssignedTo)
- Add `$orderby` for consistent ordering (typically `Created desc`)
- Limit results with `$top` (default 500 for ideas)
- Filter with `$filter`: `Status eq 'Approved'`, `IdeaId eq 20`

### Styling
- CSS Modules for all components (`.module.css`)
- BEM-like naming: `cardHeader`, `ideaTitle`, `statusPending`
- Avoid inline styles unless dynamic (status colors)
- Use Bootstrap classes sparingly (prefer custom CSS)
- Responsive breakpoints: 768px, 1024px, 1440px

### Logging
- `logInfo()` for successful operations, state changes
- `logError()` for caught exceptions (include context object)
- Log API responses: status, contentType, url
- Never log sensitive data (passwords, tokens)

## Build & Deployment

### Development
```bash
npm run dev          # Vite dev server on localhost:5173
npm run test         # Jest unit tests
npm run lint         # ESLint + Prettier
```

### Production Build
```bash
npm run build:sharepoint  # Builds with base: '/innovativeIdeas/dist/'
# Output: dist/ directory with index.html + assets/
```

### Deployment to SharePoint
```bash
npm run deploy       # Runs deploy.bat
```

**Deploy Process** (`deploy.bat` â†’ `deploy.ps1`):
1. `npm run build:sharepoint` - Vite build with SharePoint base path
2. PowerShell REST API calls:
   - GET `/_api/contextinfo` for form digest
   - DELETE old files in `/innovativeIdeas/dist/assets/`
   - DELETE old `index.html`
   - POST new files via `/_api/web/GetFolderByServerRelativeUrl('/innovativeIdeas/dist')/Files/Add`
3. Uploads: index.html + all assets/*.js, assets/*.css

**Live URL**: `http://hospp16srv:36156/innovativeIdeas/dist/index.html`

### Vite Configuration Highlights
```javascript
base: '/innovativeIdeas/dist/',  // Production path
publicDir: 'public',              // Static assets
cssCodeSplit: false,              // Single CSS bundle
manualChunks: {
  vendor: ['react', 'react-dom'],  // Separate vendor bundle
  app: [...],                      // App code
}
```

## Common Issues & Solutions

### 1. "Everyone" Group Detection
**Problem**: Users in "Everyone" SharePoint group not recognized as contributors
**Solution**: `userApi.ts` sets `isContributor = true` for ALL authenticated users (no group check)

### 2. React Flow Edges Not Showing
**Problem**: Empty edges array in IdeaTrailModal
**Solution**: Ensure trail events are sorted by timestamp, build edges from consecutive events

### 3. CSRF Token Expired
**Problem**: 403 Forbidden on POST/PATCH requests
**Solution**: `secureApi.ts` automatically refetches form digest on 403 and retries

### 4. Attachment Upload Failures
**Problem**: Large files timeout or fail
**Solution**: Upload attachments after idea creation (2-step process), use FormData with `Content-Type: undefined`

### 5. Hash Routing Issues
**Problem**: Direct URL access fails in SharePoint
**Solution**: Must use HashRouter (not BrowserRouter); SharePoint serves index.html for all paths under `/innovativeIdeas/dist/`

## Testing Guidelines

### Unit Tests (Jest)
- Mock SharePoint API responses with `jest.mock()`
- Test data transformations: `processIdea()`, `processTask()`
- Test status transition logic in DataContext
- Snapshot tests for static UI components

### Integration Tests
- Test full idea submission flow
- Test status update with trail event creation
- Test task creation and assignment
- Test user permission checks

### Manual Testing Checklist
- [ ] Submit new idea with attachments
- [ ] Approve idea (as approver)
- [ ] Change status to In Progress (verify implementation_started event)
- [ ] Change status to Completed (verify implementation_completed event)
- [ ] Create task for approved idea
- [ ] View idea trail timeline (verify all events appear)
- [ ] Test as different roles (contributor, approver, admin)

## Do's and Don'ts

### âœ… Do
- Use `sharePointApi.get/post/patch/delete` for all SharePoint API calls
- Include comprehensive $select/$expand in OData queries
- Add null checks before accessing nested API data
- Log API errors with context (ideaId, userId, etc.)
- Use CSS Modules for all component styles
- Keep components under 300 lines (split if larger)
- Write descriptive commit messages
- Test locally before deploying to SharePoint

### âŒ Don't
- Hardcode SharePoint URLs (use `getBaseUrl()` or config)
- Remove HashRouter (breaks SharePoint compatibility)
- Change SharePoint list names (breaks API calls)
- Commit `dist/` directory (auto-generated)
- Re-enable PWA in SharePoint mode (causes caching issues)
- Use inline styles except for dynamic values
- Skip form digest for mutating operations (POST/PATCH/DELETE)
- Deploy without testing status transitions
- Remove logging from production builds (helps debugging)

## Future Enhancements
- Real-time updates via SignalR or polling
- Advanced analytics dashboard with Chart.js
- Email notifications for status changes
- Bulk idea import from Excel
- Integration with Microsoft Teams
- Mobile-responsive improvements
- Idea voting/commenting system
- Department-based idea filtering
- Custom workflow stages beyond default statuses

---
**Last Updated**: January 1, 2026
**Maintained By**: Development Team
**SharePoint Version**: 2016 Enterprise

### Build Configuration
- **Vite Config**: Optimized for SharePoint hosting with minimal chunking
- **Base Path**: `/innovativeIdeas/dist/` for correct asset loading
- **Asset Handling**: Excludes SharePoint system folders

### Deployment Script
Located in `deploy-rest.ps1`:
```powershell
# Key configuration
$siteUrl = "http://hospp16srv:36156"
$targetFolder = "/innovativeIdeas/dist"
$assetsFolder = "$targetFolder/assets"
```

### Deployment Steps
1. Build the application: `npm run build`
2. Run deployment script: `.\deploy-rest.ps1`
3. Verify deployment at: `http://hospp16srv:36156/innovativeIdeas/dist/index.html`

## Code Patterns and Conventions

### Component Structure
```typescript
// Use functional components with hooks
const MyComponent: React.FC<Props> = ({ prop1, prop2 }) => {
  const [state, setState] = useState(initialState);

  // Custom hooks for complex logic
  const { data, loading } = useCustomHook();

  return (
    <div className={styles.container}>
      {/* Component JSX */}
    </div>
  );
};
```

### CSS Modules
```typescript
// component.module.css
.container {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.title {
  color: var(--color-primary);
  font-weight: 600;
}

// component.tsx
import styles from './component.module.css';

const Component = () => (
  <div className={styles.container}>
    <h1 className={styles.title}>Title</h1>
  </div>
);
```

### Error Handling
```typescript
try {
  const result = await apiCall();
  // Handle success
} catch (error) {
  console.error('API Error:', error);
  // Show user-friendly error message
  showNotification('Failed to load data', 'error');
}
```

### State Management
```typescript
// Use context for global state
const useData = () => {
  const context = useContext(DataContext);
  if (!context) {
    throw new Error('useData must be used within DataProvider');
  }
  return context;
};

// Component usage
const MyComponent = () => {
  const { ideas, loadIdeas } = useData();

  useEffect(() => {
    loadIdeas();
  }, [loadIdeas]);

  return <div>{/* Render ideas */}</div>;
};
```

## Testing Guidelines

### Unit Tests
- Use Jest with React Testing Library
- Test component rendering and interactions
- Mock API calls and external dependencies
- Aim for 80%+ code coverage

### Integration Tests
- Test complete user workflows
- Verify API integration
- Test error scenarios

### Test Structure
```typescript
describe('IdeaForm', () => {
  it('submits idea successfully', async () => {
    render(<IdeaForm />, { wrapper: TestProviders });

    // Fill form
    fireEvent.change(screen.getByLabelText('Title'), {
      target: { value: 'Test Idea' }
    });

    // Submit
    fireEvent.click(screen.getByText('Submit'));

    // Verify API call
    await waitFor(() => {
      expect(mockApi.createIdea).toHaveBeenCalledWith({
        title: 'Test Idea',
        // ... other fields
      });
    });
  });
});
```

## Performance Considerations

### Optimization Techniques
- **Code Splitting**: Automatic chunking by Vite
- **Lazy Loading**: Route-based code splitting
- **Memoization**: React.memo for expensive components
- **Virtual Scrolling**: For large lists
- **Image Optimization**: WebP format with fallbacks

### Monitoring
- **Performance Metrics**: Track Core Web Vitals
- **Bundle Analysis**: Monitor bundle sizes
- **API Performance**: Track response times
- **Error Tracking**: Log and monitor errors

## Security Best Practices

### Authentication
- Windows authentication only
- No custom login forms
- Form digest validation for all API calls

### Data Protection
- Input validation and sanitization
- XSS protection through React's built-in escaping
- CSRF protection via SharePoint form digests

### API Security
- Rate limiting on API calls
- Error message sanitization
- Secure headers configuration

## Troubleshooting

### Common Issues

#### Build Errors
- **Missing dependencies**: Run `npm install`
- **TypeScript errors**: Check type definitions in `src/types/`
- **CSS module issues**: Verify file naming conventions

#### Deployment Issues
- **Authentication errors**: Verify Windows credentials
- **Permission errors**: Check SharePoint permissions
- **Path errors**: Verify folder structure in document library

#### Runtime Issues
- **API failures**: Check network connectivity and SharePoint availability
- **Asset loading errors**: Verify base path configuration
- **CORS errors**: Ensure proper SharePoint configuration

### Debug Mode
Enable debug logging by setting:
```typescript
localStorage.setItem('debug', 'true');
```

## Contributing Guidelines

### Code Style
- Use TypeScript for all new code
- Follow React best practices
- Use CSS modules for component styling
- Write descriptive commit messages

### Pull Request Process
1. Create feature branch from `main`
2. Implement changes with tests
3. Update documentation if needed
4. Submit PR with description
5. Code review and approval
6. Merge after CI passes

### Documentation Updates
- Update this file for architectural changes
- Add JSDoc comments for new functions
- Update README for user-facing changes

## Future Enhancements

### Planned Features
- [ ] Advanced search and filtering
- [ ] Idea voting system
- [ ] Automated notifications
- [ ] Analytics dashboard
- [ ] Mobile app companion
- [ ] Integration with other enterprise systems

### Technical Debt
- [ ] Migrate to React Query for better data fetching
- [ ] Implement proper error boundaries
- [ ] Add comprehensive end-to-end tests
- [ ] Optimize bundle size further
- [ ] Add internationalization support

---

## Quick Reference

### Important URLs
- **Development**: `http://localhost:5173`
- **Production**: `http://hospp16srv:36156/innovativeIdeas/dist/index.html`
- **SharePoint Site**: `http://hospp16srv:36156`

### Key Files
- `src/App.tsx` - Main application component
- `src/contexts/DataContext.tsx` - Data management
- `src/services/ideaApi.ts` - API integration
- `src/utils/secureApi.ts` - Secure API client
- `vite.config.js` - Build configuration
- `deploy-rest.ps1` - Deployment script

### Environment Variables
```bash
# No environment variables currently used
# All configuration is hardcoded for SharePoint environment
```

This document serves as a comprehensive guide for understanding, developing, and maintaining the Innovative Ideas SharePoint application. Keep it updated as the project evolves.